import os
os.environ['PYSPARK_SUBMIT_ARGS'] = '--jars $SPARK_HOME/jars/spark-streaming-kafka-0-8-assembly_2.11-2.1.0.jar pyspark-shell'
from pyspark import SparkConf, SparkContext
from pyspark.streaming import StreamingContext
from pyspark.streaming.kafka import KafkaUtils
from kafka import SimpleProducer, KafkaClient
import json
import csv
from pyspark.sql import Row, SparkSession
from pyspark.ml.feature import Tokenizer
from pyspark.ml.feature import StopWordsRemover
from pyspark.ml.feature import Word2Vec
from pyspark.ml.classification import LogisticRegression


def getSparkSessionInstance(sparkConf):
    if ('sparkSessionInstance' not in globals()):
        globals()['sparkSessionInstance'] = SparkSession.builder.config(conf=sparkConf) \
                                                    .enableHiveSupport().getOrCreate()
    return globals()['sparkSessionInstance']

def machinelearnig():
    data1 = sc.textFile("/user/SentimentalData/trainingData.csv")
    spark = getSparkSessionInstance(data1.context.getConf())

    r1 = data1.mapPartitions(lambda x : csv.reader(x)).map(lambda x: [x[3], x[1]])
    rddr1 = r1.map(lambda x: [x[0].replace(',',' '),x[1]]).map(lambda x: [x[0].replace('/',' '),x[1]]).map(lambda x: [x[0].replace('?',' '),x[1]])
    rddr1 = rddr1.map(lambda x: [x[0].replace(':',' '),x[1]]).map(lambda x: [x[0].replace('-',' '),x[1]]).map(lambda x: [x[0].replace('.',' '),x[1]])
    rddr1 = rddr1.map(lambda x: [x[0].replace(')',' '),x[1]]).map(lambda x: [x[0].replace('(',' '),x[1]]).map(lambda x: [x[0].replace('!',' '),x[1]])
    rddr1 = rddr1.map(lambda sn: [' '.join(filter(lambda x: x.startswith(('@','http','"','&','rt')) == False, sn[0].split() )), sn[1]] )
    rddr1 = rddr1.map(lambda sn: [' '.join(filter(lambda x: (x.endswith(('"')) == False) and len(x) > 2 , sn[0].split() )), sn[1]] )
    rddr1 = rddr1.map(lambda sn: [' '.join(filter(lambda x: "a's" != x and x != "able" and x != "about" and x != "above" and x != "according" and x != "accordingly" and x != "across" and x != "actually" and x != "after" and x != "afterwards" and x != "again" and x != "against" and x != "ain't" and x != "all" and x != "allow" and x != "allows" and x != "almost" and x != "alone" and x != "along" and x != "already" and x != "also" and x != "although" and x != "always" and x != "am" and x != "among" and x != "amongst" and x != "an" and x != "and" and x != "another" and x != "any" and x != "anybody" and x != "anyhow" and x != "anyone" and x != "anything" and x != "anyway" and x != "anyways" and x != "anywhere" and x != "apart" and x != "appear" and x != "appreciate" and x != "appropriate" and x != "are" and x != "aren't" and x != "around" and x != "as" and x != "aside" and x != "ask" and x != "asking" and x != "associated" and x != "at" and x != "available" and x != "away" and x != "awfully" and x != "b" and x != "be" and x != "became" and x != "because" and x != "become" and x != "becomes" and x != "becoming" and x != "been" and x != "before" and x != "beforehand" and x != "behind" and x != "being" and x != "believe" and x != "below" and x != "beside" and x != "besides" and x != "best" and x != "better" and x != "between" and x != "beyond" and x != "both" and x != "brief" and x != "but" and x != "by" and x != "c" and x != "c'mon" and x != "c's" and x != "came" and x != "can" and x != "can't" and x != "cannot" and x != "cant" and x != "cause" and x != "causes" and x != "certain" and x != "certainly" and x != "changes" and x != "clearly" and x != "co" and x != "com" and x != "come" and x != "comes" and x != "concerning" and x != "consequently" and x != "consider" and x != "considering" and x != "contain" and x != "containing" and x != "contains" and x != "corresponding" and x != "could" and x != "couldn't" and x != "course" and x != "currently" and x != "d" and x != "definitely" and x != "described" and x != "despite" and x != "did" and x != "didn't" and x != "different" and x != "do" and x != "does" and x != "doesn't" and x != "doing" and x != "don't" and x != "done" and x != "down" and x != "downwards" and x != "during" and x != "e" and x != "each" and x != "edu" and x != "eg" and x != "eight" and x != "either" and x != "else" and x != "elsewhere" and x != "enough" and x != "entirely" and x != "especially" and x != "et" and x != "etc" and x != "even" and x != "ever" and x != "every" and x != "everybody" and x != "everyone" and x != "everything" and x != "everywhere" and x != "ex" and x != "exactly" and x != "example" and x != "except" and x != "f" and x != "far" and x != "few" and x != "fifth" and x != "first" and x != "five" and x != "followed" and x != "following" and x != "follows" and x != "for" and x != "former" and x != "formerly" and x != "forth" and x != "four" and x != "from" and x != "further" and x != "furthermore" and x != "g" and x != "get" and x != "gets" and x != "getting" and x != "given" and x != "gives" and x != "go" and x != "goes" and x != "going" and x != "gone" and x != "got" and x != "gotten" and x != "greetings" and x != "h" and x != "had" and x != "hadn't" and x != "happens" and x != "hardly" and x != "has" and x != "hasn't" and x != "have" and x != "haven't" and x != "having" and x != "he" and x != "he's" and x != "hello" and x != "help" and x != "hence" and x != "her" and x != "here" and x != "here's" and x != "hereafter" and x != "hereby" and x != "herein" and x != "hereupon" and x != "hers" and x != "herself" and x != "hi" and x != "him" and x != "himself" and x != "his" and x != "hither" and x != "hopefully" and x != "how" and x != "howbeit" and x != "however" and x != "i" and x != "i'd" and x != "i'll" and x != "i'm" and x != "i've" and x != "ie" and x != "if" and x != "ignored" and x != "immediate" and x != "in" and x != "inasmuch" and x != "inc" and x != "indeed" and x != "indicate" and x != "indicated" and x != "indicates" and x != "inner" and x != "insofar" and x != "instead" and x != "into" and x != "inward" and x != "is" and x != "isn't" and x != "it" and x != "it'd" and x != "it'll" and x != "it's" and x != "its" and x != "itself" and x != "j" and x != "just" and x != "k" and x != "keep" and x != "keeps" and x != "kept" and x != "know" and x != "known" and x != "knows" and x != "l" and x != "last" and x != "lately" and x != "later" and x != "latter" and x != "latterly" and x != "least" and x != "less" and x != "lest" and x != "let" and x != "let's" and x != "like" and x != "liked" and x != "likely" and x != "little" and x != "look" and x != "looking" and x != "looks" and x != "ltd" and x != "m" and x != "mainly" and x != "many" and x != "may" and x != "maybe" and x != "me" and x != "mean" and x != "meanwhile" and x != "merely" and x != "might" and x != "more" and x != "moreover" and x != "most" and x != "mostly" and x != "much" and x != "must" and x != "my" and x != "myself" and x != "n" and x != "name" and x != "namely" and x != "nd" and x != "near" and x != "nearly" and x != "necessary" and x != "need" and x != "needs" and x != "neither" and x != "never" and x != "nevertheless" and x != "new" and x != "next" and x != "nine" and x != "no" and x != "nobody" and x != "non" and x != "none" and x != "noone" and x != "nor" and x != "normally" and x != "not" and x != "nothing" and x != "novel" and x != "now" and x != "nowhere" and x != "o" and x != "obviously" and x != "of" and x != "off" and x != "often" and x != "oh" and x != "ok" and x != "okay" and x != "old" and x != "on" and x != "once" and x != "one" and x != "ones" and x != "only" and x != "onto" and x != "or" and x != "other" and x != "others" and x != "otherwise" and x != "ought" and x != "our" and x != "ours" and x != "ourselves" and x != "out" and x != "outside" and x != "over" and x != "overall" and x != "own" and x != "p" and x != "particular" and x != "particularly" and x != "per" and x != "perhaps" and x != "placed" and x != "please" and x != "plus" and x != "possible" and x != "presumably" and x != "probably" and x != "provides" and x != "q" and x != "que" and x != "quite" and x != "qv" and x != "r" and x != "rather" and x != "rd" and x != "re" and x != "really" and x != "reasonably" and x != "regarding" and x != "regardless" and x != "regards" and x != "relatively" and x != "respectively" and x != "right" and x != "s" and x != "said" and x != "same" and x != "saw" and x != "say" and x != "saying" and x != "says" and x != "second" and x != "secondly" and x != "see" and x != "seeing" and x != "seem" and x != "seemed" and x != "seeming" and x != "seems" and x != "seen" and x != "self" and x != "selves" and x != "sensible" and x != "sent" and x != "serious" and x != "seriously" and x != "seven" and x != "several" and x != "shall" and x != "she" and x != "should" and x != "shouldn't" and x != "since" and x != "six" and x != "so" and x != "some" and x != "somebody" and x != "somehow" and x != "someone" and x != "something" and x != "sometime" and x != "sometimes" and x != "somewhat" and x != "somewhere" and x != "soon" and x != "sorry" and x != "specified" and x != "specify" and x != "specifying" and x != "still" and x != "sub" and x != "such" and x != "sup" and x != "sure" and x != "t" and x != "t's" and x != "take" and x != "taken" and x != "tell" and x != "tends" and x != "th" and x != "than" and x != "thank" and x != "thanks" and x != "thanx" and x != "that" and x != "that's" and x != "thats" and x != "the" and x != "their" and x != "theirs" and x != "them" and x != "themselves" and x != "then" and x != "thence" and x != "there" and x != "there's" and x != "thereafter" and x != "thereby" and x != "therefore" and x != "therein" and x != "theres" and x != "thereupon" and x != "these" and x != "they" and x != "they'd" and x != "they'll" and x != "they're" and x != "they've" and x != "think" and x != "third" and x != "this" and x != "thorough" and x != "thoroughly" and x != "those" and x != "though" and x != "three" and x != "through" and x != "throughout" and x != "thru" and x != "thus" and x != "to" and x != "together" and x != "too" and x != "took" and x != "toward" and x != "towards" and x != "tried" and x != "tries" and x != "truly" and x != "try" and x != "trying" and x != "twice" and x != "two" and x != "u" and x != "un" and x != "under" and x != "unfortunately" and x != "unless" and x != "unlikely" and x != "until" and x != "unto" and x != "up" and x != "upon" and x != "us" and x != "use" and x != "used" and x != "useful" and x != "uses" and x != "using" and x != "usually" and x != "uucp" and x != "v" and x != "value" and x != "various" and x != "very" and x != "via" and x != "viz" and x != "vs" and x != "w" and x != "want" and x != "wants" and x != "was" and x != "wasn't" and x != "way" and x != "we" and x != "we'd" and x != "we'll" and x != "we're" and x != "we've" and x != "welcome" and x != "well" and x != "went" and x != "were" and x != "weren't" and x != "what" and x != "what's" and x != "whatever" and x != "when" and x != "whence" and x != "whenever" and x != "where" and x != "where's" and x != "whereafter" and x != "whereas" and x != "whereby" and x != "wherein" and x != "whereupon" and x != "wherever" and x != "whether" and x != "which" and x != "while" and x != "whither" and x != "who" and x != "who's" and x != "whoever" and x != "whole" and x != "whom" and x != "whose" and x != "why" and x != "will" and x != "willing" and x != "wish" and x != "with" and x != "within" and x != "without" and x != "won't" and x != "wonder" and x != "would" and x != "wouldn't" and x != "x" and x != "y" and x != "yes" and x != "yet" and x != "you" and x != "you'd" and x != "you'll" and x != "you're" and x != "you've" and x != "your" and x != "yours" and x != "yourself" and x != "yourselves" and x != "z" and x != "zero" , sn[0].split() )), sn[1]] )

    partsDF1 = spark.createDataFrame( rddr1.map(lambda x : Row(sentence=str.strip(x[0]), label=int(x[1]))) )
    tokenizer = Tokenizer(inputCol="sentence", outputCol="words")
    tokenized1 = tokenizer.transform(partsDF1)
    remover = StopWordsRemover(inputCol="words", outputCol="base_words")
    base_words1 = remover.transform(tokenized1)
    train_data_raw1 = base_words1.select("base_words", "label")
    word2Vec1 = Word2Vec(vectorSize=3, minCount=0, inputCol="base_words", outputCol="features")
    model1 = word2Vec1.fit(train_data_raw1)
    final_train_data1 = model1.transform(train_data_raw1)
    final_train_data1 = final_train_data1.select("label", "features")
      
    lr = LogisticRegression(maxIter=2000, regParam=0.001, elasticNetParam=0.0001)
    lrModel = lr.fit(final_train_data1)
    lrModel.transform(final_train_data1)
    
    data2 = sc.textFile("/user/ml/testData.csv")
    r2 = data1.mapPartitions(lambda x : csv.reader(x))

    r2 = data2.mapPartitions(lambda x : csv.reader(x)).map(lambda x: [x[3], x[1]])
    rddr2 = r2.map(lambda x: [x[0].replace(',',' '),x[1]]).map(lambda x: [x[0].replace('/',' '),x[1]]).map(lambda x: [x[0].replace('?',' '),x[1]])
    rddr2 = rddr2.map(lambda x: [x[0].replace(':',' '),x[1]]).map(lambda x: [x[0].replace('-',' '),x[1]]).map(lambda x: [x[0].replace('.',' '),x[1]])
    rddr2 = rddr2.map(lambda x: [x[0].replace(')',' '),x[1]]).map(lambda x: [x[0].replace('(',' '),x[1]]).map(lambda x: [x[0].replace('!',' '),x[1]])
    rddr2 = rddr2.map(lambda sn: [' '.join(filter(lambda x: x.startswith(('@','http','"','&','rt')) == False, sn[0].split() )), sn[1]] )
    rddr2 = rddr2.map(lambda sn: [' '.join(filter(lambda x: (x.endswith(('"')) == False) and len(x) > 2 , sn[0].split() )), sn[1]] )
    rddr2 = rddr2.map(lambda sn: [' '.join(filter(lambda x: "a's" != x and x != "able" and x != "about" and x != "above" and x != "according" and x != "accordingly" and x != "across" and x != "actually" and x != "after" and x != "afterwards" and x != "again" and x != "against" and x != "ain't" and x != "all" and x != "allow" and x != "allows" and x != "almost" and x != "alone" and x != "along" and x != "already" and x != "also" and x != "although" and x != "always" and x != "am" and x != "among" and x != "amongst" and x != "an" and x != "and" and x != "another" and x != "any" and x != "anybody" and x != "anyhow" and x != "anyone" and x != "anything" and x != "anyway" and x != "anyways" and x != "anywhere" and x != "apart" and x != "appear" and x != "appreciate" and x != "appropriate" and x != "are" and x != "aren't" and x != "around" and x != "as" and x != "aside" and x != "ask" and x != "asking" and x != "associated" and x != "at" and x != "available" and x != "away" and x != "awfully" and x != "b" and x != "be" and x != "became" and x != "because" and x != "become" and x != "becomes" and x != "becoming" and x != "been" and x != "before" and x != "beforehand" and x != "behind" and x != "being" and x != "believe" and x != "below" and x != "beside" and x != "besides" and x != "best" and x != "better" and x != "between" and x != "beyond" and x != "both" and x != "brief" and x != "but" and x != "by" and x != "c" and x != "c'mon" and x != "c's" and x != "came" and x != "can" and x != "can't" and x != "cannot" and x != "cant" and x != "cause" and x != "causes" and x != "certain" and x != "certainly" and x != "changes" and x != "clearly" and x != "co" and x != "com" and x != "come" and x != "comes" and x != "concerning" and x != "consequently" and x != "consider" and x != "considering" and x != "contain" and x != "containing" and x != "contains" and x != "corresponding" and x != "could" and x != "couldn't" and x != "course" and x != "currently" and x != "d" and x != "definitely" and x != "described" and x != "despite" and x != "did" and x != "didn't" and x != "different" and x != "do" and x != "does" and x != "doesn't" and x != "doing" and x != "don't" and x != "done" and x != "down" and x != "downwards" and x != "during" and x != "e" and x != "each" and x != "edu" and x != "eg" and x != "eight" and x != "either" and x != "else" and x != "elsewhere" and x != "enough" and x != "entirely" and x != "especially" and x != "et" and x != "etc" and x != "even" and x != "ever" and x != "every" and x != "everybody" and x != "everyone" and x != "everything" and x != "everywhere" and x != "ex" and x != "exactly" and x != "example" and x != "except" and x != "f" and x != "far" and x != "few" and x != "fifth" and x != "first" and x != "five" and x != "followed" and x != "following" and x != "follows" and x != "for" and x != "former" and x != "formerly" and x != "forth" and x != "four" and x != "from" and x != "further" and x != "furthermore" and x != "g" and x != "get" and x != "gets" and x != "getting" and x != "given" and x != "gives" and x != "go" and x != "goes" and x != "going" and x != "gone" and x != "got" and x != "gotten" and x != "greetings" and x != "h" and x != "had" and x != "hadn't" and x != "happens" and x != "hardly" and x != "has" and x != "hasn't" and x != "have" and x != "haven't" and x != "having" and x != "he" and x != "he's" and x != "hello" and x != "help" and x != "hence" and x != "her" and x != "here" and x != "here's" and x != "hereafter" and x != "hereby" and x != "herein" and x != "hereupon" and x != "hers" and x != "herself" and x != "hi" and x != "him" and x != "himself" and x != "his" and x != "hither" and x != "hopefully" and x != "how" and x != "howbeit" and x != "however" and x != "i" and x != "i'd" and x != "i'll" and x != "i'm" and x != "i've" and x != "ie" and x != "if" and x != "ignored" and x != "immediate" and x != "in" and x != "inasmuch" and x != "inc" and x != "indeed" and x != "indicate" and x != "indicated" and x != "indicates" and x != "inner" and x != "insofar" and x != "instead" and x != "into" and x != "inward" and x != "is" and x != "isn't" and x != "it" and x != "it'd" and x != "it'll" and x != "it's" and x != "its" and x != "itself" and x != "j" and x != "just" and x != "k" and x != "keep" and x != "keeps" and x != "kept" and x != "know" and x != "known" and x != "knows" and x != "l" and x != "last" and x != "lately" and x != "later" and x != "latter" and x != "latterly" and x != "least" and x != "less" and x != "lest" and x != "let" and x != "let's" and x != "like" and x != "liked" and x != "likely" and x != "little" and x != "look" and x != "looking" and x != "looks" and x != "ltd" and x != "m" and x != "mainly" and x != "many" and x != "may" and x != "maybe" and x != "me" and x != "mean" and x != "meanwhile" and x != "merely" and x != "might" and x != "more" and x != "moreover" and x != "most" and x != "mostly" and x != "much" and x != "must" and x != "my" and x != "myself" and x != "n" and x != "name" and x != "namely" and x != "nd" and x != "near" and x != "nearly" and x != "necessary" and x != "need" and x != "needs" and x != "neither" and x != "never" and x != "nevertheless" and x != "new" and x != "next" and x != "nine" and x != "no" and x != "nobody" and x != "non" and x != "none" and x != "noone" and x != "nor" and x != "normally" and x != "not" and x != "nothing" and x != "novel" and x != "now" and x != "nowhere" and x != "o" and x != "obviously" and x != "of" and x != "off" and x != "often" and x != "oh" and x != "ok" and x != "okay" and x != "old" and x != "on" and x != "once" and x != "one" and x != "ones" and x != "only" and x != "onto" and x != "or" and x != "other" and x != "others" and x != "otherwise" and x != "ought" and x != "our" and x != "ours" and x != "ourselves" and x != "out" and x != "outside" and x != "over" and x != "overall" and x != "own" and x != "p" and x != "particular" and x != "particularly" and x != "per" and x != "perhaps" and x != "placed" and x != "please" and x != "plus" and x != "possible" and x != "presumably" and x != "probably" and x != "provides" and x != "q" and x != "que" and x != "quite" and x != "qv" and x != "r" and x != "rather" and x != "rd" and x != "re" and x != "really" and x != "reasonably" and x != "regarding" and x != "regardless" and x != "regards" and x != "relatively" and x != "respectively" and x != "right" and x != "s" and x != "said" and x != "same" and x != "saw" and x != "say" and x != "saying" and x != "says" and x != "second" and x != "secondly" and x != "see" and x != "seeing" and x != "seem" and x != "seemed" and x != "seeming" and x != "seems" and x != "seen" and x != "self" and x != "selves" and x != "sensible" and x != "sent" and x != "serious" and x != "seriously" and x != "seven" and x != "several" and x != "shall" and x != "she" and x != "should" and x != "shouldn't" and x != "since" and x != "six" and x != "so" and x != "some" and x != "somebody" and x != "somehow" and x != "someone" and x != "something" and x != "sometime" and x != "sometimes" and x != "somewhat" and x != "somewhere" and x != "soon" and x != "sorry" and x != "specified" and x != "specify" and x != "specifying" and x != "still" and x != "sub" and x != "such" and x != "sup" and x != "sure" and x != "t" and x != "t's" and x != "take" and x != "taken" and x != "tell" and x != "tends" and x != "th" and x != "than" and x != "thank" and x != "thanks" and x != "thanx" and x != "that" and x != "that's" and x != "thats" and x != "the" and x != "their" and x != "theirs" and x != "them" and x != "themselves" and x != "then" and x != "thence" and x != "there" and x != "there's" and x != "thereafter" and x != "thereby" and x != "therefore" and x != "therein" and x != "theres" and x != "thereupon" and x != "these" and x != "they" and x != "they'd" and x != "they'll" and x != "they're" and x != "they've" and x != "think" and x != "third" and x != "this" and x != "thorough" and x != "thoroughly" and x != "those" and x != "though" and x != "three" and x != "through" and x != "throughout" and x != "thru" and x != "thus" and x != "to" and x != "together" and x != "too" and x != "took" and x != "toward" and x != "towards" and x != "tried" and x != "tries" and x != "truly" and x != "try" and x != "trying" and x != "twice" and x != "two" and x != "u" and x != "un" and x != "under" and x != "unfortunately" and x != "unless" and x != "unlikely" and x != "until" and x != "unto" and x != "up" and x != "upon" and x != "us" and x != "use" and x != "used" and x != "useful" and x != "uses" and x != "using" and x != "usually" and x != "uucp" and x != "v" and x != "value" and x != "various" and x != "very" and x != "via" and x != "viz" and x != "vs" and x != "w" and x != "want" and x != "wants" and x != "was" and x != "wasn't" and x != "way" and x != "we" and x != "we'd" and x != "we'll" and x != "we're" and x != "we've" and x != "welcome" and x != "well" and x != "went" and x != "were" and x != "weren't" and x != "what" and x != "what's" and x != "whatever" and x != "when" and x != "whence" and x != "whenever" and x != "where" and x != "where's" and x != "whereafter" and x != "whereas" and x != "whereby" and x != "wherein" and x != "whereupon" and x != "wherever" and x != "whether" and x != "which" and x != "while" and x != "whither" and x != "who" and x != "who's" and x != "whoever" and x != "whole" and x != "whom" and x != "whose" and x != "why" and x != "will" and x != "willing" and x != "wish" and x != "with" and x != "within" and x != "without" and x != "won't" and x != "wonder" and x != "would" and x != "wouldn't" and x != "x" and x != "y" and x != "yes" and x != "yet" and x != "you" and x != "you'd" and x != "you'll" and x != "you're" and x != "you've" and x != "your" and x != "yours" and x != "yourself" and x != "yourselves" and x != "z" and x != "zero" , sn[0].split() )), sn[1]] )
    
    partsDF2 = spark.createDataFrame( rddr2.map(lambda x : Row(sentence=str.strip(x[0]), label=int(x[1]))) )
    tokenized2 = tokenizer.transform(partsDF2)
    base_words2 = remover.transform(tokenized2)
    train_data_raw2 = base_words2.select("base_words", "label")
    word2Vec2 = Word2Vec(vectorSize=3, minCount=0, inputCol="base_words", outputCol="features")
    model2 = word2Vec2.fit(train_data_raw2)
    final_train_data2 = model2.transform(train_data_raw2)
    final_train_data2 = final_train_data2.select("label", "features")

    lrModel.transform(final_train_data2)
    
    return lrModel
    
  
def streaming():
    ssc = StreamingContext(sc, 120)
    kvs = KafkaUtils.createDirectStream(ssc, ["mlproducer"], {"metadata.broker.list": "localhost:9092"})
    kvs.foreachRDD(send)
    ssc.start()
    ssc.awaitTermination()

def send(time,rdd):  
    if rdd.count() > 0:
        rdd = rdd.map(lambda x: json.loads(x[1]))
        rdd = rdd.map(lambda x: str.strip(x["text"])).map(lambda x: x.lower())
        rdd = rdd.map(lambda x: x.replace(',','')).map(lambda x: x.replace('/','')).map(lambda x: x.replace('?','')).map(lambda x: x.replace('...','')).map(lambda x: x.replace('-',''))
        rdd = rdd.map(lambda x: x.replace('.','')).map(lambda x: x.replace('(','')).map(lambda x: x.replace(')','')).map(lambda x: x.replace('!','')).map(lambda x: x.replace('|',''))
        rdd = rdd.map(lambda sn: ' '.join(filter(lambda x: x.startswith(('@','http','"','&','rt')) == False, sn.split() )) )
        rdd = rdd.map(lambda sn: ' '.join(filter(lambda x: (x.endswith(('"')) == False) and len(x) > 2 , sn.split() )) )
        rdd = rdd.map(lambda sn: ' '.join(filter(lambda x: "a's" != x and x != "able" and x != "about" and x != "above" and x != "according" and x != "accordingly" and x != "across" and x != "actually" and x != "after" and x != "afterwards" and x != "again" and x != "against" and x != "ain't" and x != "all" and x != "allow" and x != "allows" and x != "almost" and x != "alone" and x != "along" and x != "already" and x != "also" and x != "although" and x != "always" and x != "am" and x != "among" and x != "amongst" and x != "an" and x != "and" and x != "another" and x != "any" and x != "anybody" and x != "anyhow" and x != "anyone" and x != "anything" and x != "anyway" and x != "anyways" and x != "anywhere" and x != "apart" and x != "appear" and x != "appreciate" and x != "appropriate" and x != "are" and x != "aren't" and x != "around" and x != "as" and x != "aside" and x != "ask" and x != "asking" and x != "associated" and x != "at" and x != "available" and x != "away" and x != "awfully" and x != "b" and x != "be" and x != "became" and x != "because" and x != "become" and x != "becomes" and x != "becoming" and x != "been" and x != "before" and x != "beforehand" and x != "behind" and x != "being" and x != "believe" and x != "below" and x != "beside" and x != "besides" and x != "best" and x != "better" and x != "between" and x != "beyond" and x != "both" and x != "brief" and x != "but" and x != "by" and x != "c" and x != "c'mon" and x != "c's" and x != "came" and x != "can" and x != "can't" and x != "cannot" and x != "cant" and x != "cause" and x != "causes" and x != "certain" and x != "certainly" and x != "changes" and x != "clearly" and x != "co" and x != "com" and x != "come" and x != "comes" and x != "concerning" and x != "consequently" and x != "consider" and x != "considering" and x != "contain" and x != "containing" and x != "contains" and x != "corresponding" and x != "could" and x != "couldn't" and x != "course" and x != "currently" and x != "d" and x != "definitely" and x != "described" and x != "despite" and x != "did" and x != "didn't" and x != "different" and x != "do" and x != "does" and x != "doesn't" and x != "doing" and x != "don't" and x != "done" and x != "down" and x != "downwards" and x != "during" and x != "e" and x != "each" and x != "edu" and x != "eg" and x != "eight" and x != "either" and x != "else" and x != "elsewhere" and x != "enough" and x != "entirely" and x != "especially" and x != "et" and x != "etc" and x != "even" and x != "ever" and x != "every" and x != "everybody" and x != "everyone" and x != "everything" and x != "everywhere" and x != "ex" and x != "exactly" and x != "example" and x != "except" and x != "f" and x != "far" and x != "few" and x != "fifth" and x != "first" and x != "five" and x != "followed" and x != "following" and x != "follows" and x != "for" and x != "former" and x != "formerly" and x != "forth" and x != "four" and x != "from" and x != "further" and x != "furthermore" and x != "g" and x != "get" and x != "gets" and x != "getting" and x != "given" and x != "gives" and x != "go" and x != "goes" and x != "going" and x != "gone" and x != "got" and x != "gotten" and x != "greetings" and x != "h" and x != "had" and x != "hadn't" and x != "happens" and x != "hardly" and x != "has" and x != "hasn't" and x != "have" and x != "haven't" and x != "having" and x != "he" and x != "he's" and x != "hello" and x != "help" and x != "hence" and x != "her" and x != "here" and x != "here's" and x != "hereafter" and x != "hereby" and x != "herein" and x != "hereupon" and x != "hers" and x != "herself" and x != "hi" and x != "him" and x != "himself" and x != "his" and x != "hither" and x != "hopefully" and x != "how" and x != "howbeit" and x != "however" and x != "i" and x != "i'd" and x != "i'll" and x != "i'm" and x != "i've" and x != "ie" and x != "if" and x != "ignored" and x != "immediate" and x != "in" and x != "inasmuch" and x != "inc" and x != "indeed" and x != "indicate" and x != "indicated" and x != "indicates" and x != "inner" and x != "insofar" and x != "instead" and x != "into" and x != "inward" and x != "is" and x != "isn't" and x != "it" and x != "it'd" and x != "it'll" and x != "it's" and x != "its" and x != "itself" and x != "j" and x != "just" and x != "k" and x != "keep" and x != "keeps" and x != "kept" and x != "know" and x != "known" and x != "knows" and x != "l" and x != "last" and x != "lately" and x != "later" and x != "latter" and x != "latterly" and x != "least" and x != "less" and x != "lest" and x != "let" and x != "let's" and x != "like" and x != "liked" and x != "likely" and x != "little" and x != "look" and x != "looking" and x != "looks" and x != "ltd" and x != "m" and x != "mainly" and x != "many" and x != "may" and x != "maybe" and x != "me" and x != "mean" and x != "meanwhile" and x != "merely" and x != "might" and x != "more" and x != "moreover" and x != "most" and x != "mostly" and x != "much" and x != "must" and x != "my" and x != "myself" and x != "n" and x != "name" and x != "namely" and x != "nd" and x != "near" and x != "nearly" and x != "necessary" and x != "need" and x != "needs" and x != "neither" and x != "never" and x != "nevertheless" and x != "new" and x != "next" and x != "nine" and x != "no" and x != "nobody" and x != "non" and x != "none" and x != "noone" and x != "nor" and x != "normally" and x != "not" and x != "nothing" and x != "novel" and x != "now" and x != "nowhere" and x != "o" and x != "obviously" and x != "of" and x != "off" and x != "often" and x != "oh" and x != "ok" and x != "okay" and x != "old" and x != "on" and x != "once" and x != "one" and x != "ones" and x != "only" and x != "onto" and x != "or" and x != "other" and x != "others" and x != "otherwise" and x != "ought" and x != "our" and x != "ours" and x != "ourselves" and x != "out" and x != "outside" and x != "over" and x != "overall" and x != "own" and x != "p" and x != "particular" and x != "particularly" and x != "per" and x != "perhaps" and x != "placed" and x != "please" and x != "plus" and x != "possible" and x != "presumably" and x != "probably" and x != "provides" and x != "q" and x != "que" and x != "quite" and x != "qv" and x != "r" and x != "rather" and x != "rd" and x != "re" and x != "really" and x != "reasonably" and x != "regarding" and x != "regardless" and x != "regards" and x != "relatively" and x != "respectively" and x != "right" and x != "s" and x != "said" and x != "same" and x != "saw" and x != "say" and x != "saying" and x != "says" and x != "second" and x != "secondly" and x != "see" and x != "seeing" and x != "seem" and x != "seemed" and x != "seeming" and x != "seems" and x != "seen" and x != "self" and x != "selves" and x != "sensible" and x != "sent" and x != "serious" and x != "seriously" and x != "seven" and x != "several" and x != "shall" and x != "she" and x != "should" and x != "shouldn't" and x != "since" and x != "six" and x != "so" and x != "some" and x != "somebody" and x != "somehow" and x != "someone" and x != "something" and x != "sometime" and x != "sometimes" and x != "somewhat" and x != "somewhere" and x != "soon" and x != "sorry" and x != "specified" and x != "specify" and x != "specifying" and x != "still" and x != "sub" and x != "such" and x != "sup" and x != "sure" and x != "t" and x != "t's" and x != "take" and x != "taken" and x != "tell" and x != "tends" and x != "th" and x != "than" and x != "thank" and x != "thanks" and x != "thanx" and x != "that" and x != "that's" and x != "thats" and x != "the" and x != "their" and x != "theirs" and x != "them" and x != "themselves" and x != "then" and x != "thence" and x != "there" and x != "there's" and x != "thereafter" and x != "thereby" and x != "therefore" and x != "therein" and x != "theres" and x != "thereupon" and x != "these" and x != "they" and x != "they'd" and x != "they'll" and x != "they're" and x != "they've" and x != "think" and x != "third" and x != "this" and x != "thorough" and x != "thoroughly" and x != "those" and x != "though" and x != "three" and x != "through" and x != "throughout" and x != "thru" and x != "thus" and x != "to" and x != "together" and x != "too" and x != "took" and x != "toward" and x != "towards" and x != "tried" and x != "tries" and x != "truly" and x != "try" and x != "trying" and x != "twice" and x != "two" and x != "u" and x != "un" and x != "under" and x != "unfortunately" and x != "unless" and x != "unlikely" and x != "until" and x != "unto" and x != "up" and x != "upon" and x != "us" and x != "use" and x != "used" and x != "useful" and x != "uses" and x != "using" and x != "usually" and x != "uucp" and x != "v" and x != "value" and x != "various" and x != "very" and x != "via" and x != "viz" and x != "vs" and x != "w" and x != "want" and x != "wants" and x != "was" and x != "wasn't" and x != "way" and x != "we" and x != "we'd" and x != "we'll" and x != "we're" and x != "we've" and x != "welcome" and x != "well" and x != "went" and x != "were" and x != "weren't" and x != "what" and x != "what's" and x != "whatever" and x != "when" and x != "whence" and x != "whenever" and x != "where" and x != "where's" and x != "whereafter" and x != "whereas" and x != "whereby" and x != "wherein" and x != "whereupon" and x != "wherever" and x != "whether" and x != "which" and x != "while" and x != "whither" and x != "who" and x != "who's" and x != "whoever" and x != "whole" and x != "whom" and x != "whose" and x != "why" and x != "will" and x != "willing" and x != "wish" and x != "with" and x != "within" and x != "without" and x != "won't" and x != "wonder" and x != "would" and x != "wouldn't" and x != "x" and x != "y" and x != "yes" and x != "yet" and x != "you" and x != "you'd" and x != "you'll" and x != "you're" and x != "you've" and x != "your" and x != "yours" and x != "yourself" and x != "yourselves" and x != "z" and x != "zero" , sn.split() )) )

        collision = rdd.filter(lambda x: "collision" in x).map(lambda x: [x, "collision"])
        fatal = rdd.filter(lambda x: "fatal" in x).map(lambda x: [x, "fatal"])
        crash = rdd.filter(lambda x: "crash" in x).map(lambda x: [x, "crash"])
        hitandrun = rdd.filter(lambda x: "hitandrun" in x).map(lambda x: [x, "hitandrun"])
        run over = rdd.filter(lambda x: "run over" in x).map(lambda x: [x, "run over"])
        shunt = rdd.filter(lambda x: "shunt" in x).map(lambda x: [x, "shunt"])
        traffic = rdd.filter(lambda x: "traffic" in x).map(lambda x: [x, "traffic"])
        emergency = rdd.filter(lambda x: "emergency" in x).map(lambda x: [x, "emergency"])
        tire = rdd.filter(lambda x: "hazard" in x).map(lambda x: [x, "hazard"])
        block = rdd.filter(lambda x: "block" in x).map(lambda x: [x, "block"])
        wiper = rdd.filter(lambda x: "wiper" in x).map(lambda x: [x, "wiper"])
        dead = rdd.filter(lambda x: "dead" in x).map(lambda x: [x, "dead"])
        car crash = rdd.filter(lambda x: "car crash" in x).map(lambda x: [x, "car crash"])
        prang = rdd.filter(lambda x: "prang" in x).map(lambda x: [x, "prang"])
        run into = rdd.filter(lambda x: "run into" in x).map(lambda x: [x, "run into"])
        bump = rdd.filter(lambda x: "bump" in x).map(lambda x: [x, "bump"])
        weather = rdd.filter(lambda x: "weather" in x).map(lambda x: [x, "weather"])
        visibility = rdd.filter(lambda x: "visibility" in x).map(lambda x: [x, "visibility"])
        rain = rdd.filter(lambda x: "rain" in x).map(lambda x: [x, "rain"])
        snowy = rdd.filter(lambda x: "snowy" in x).map(lambda x: [x, "snowy"])
        road work = rdd.filter(lambda x: "road work" in x).map(lambda x: [x, "road work"])
        obstacle = rdd.filter(lambda x: "obstacle" in x).map(lambda x: [x, "obstacle"])
        closure = rdd.filter(lambda x: "closure" in x).map(lambda x: [x, "closure"])
        injury = rdd.filter(lambda x: "injury" in x).map(lambda x: [x, "injury"])
        sentences=collision.union(fatal).union(crash).union(hitandrun).union(run over).union(shunt).union(traffic).union(emergency).union(tire).union(block).union(wiper).union(dead).union(car crash).union(prang).union(run into).union(bump).union(weather).union(visibility).union(rain).union(snowy).union(road work).union(obstacle).union(closure).union(injury)

        spark = getSparkSessionInstance(sentences.context.getConf())
    
        if sentences.count() > 0:
            partsDF3 = spark.createDataFrame(sentences.map(lambda x: Row( sentence=x[0], type= x[1], timestamp = time )))
            tokenizer = Tokenizer(inputCol="sentence", outputCol="words")
            tokenized3 = tokenizer.transform(partsDF3)
            remover = StopWordsRemover(inputCol="words", outputCol="base_words")
            base_words3 = remover.transform(tokenized3)
            train_data_raw3 = base_words3.select("base_words", "type", "timestamp")
            word2Vec3 = Word2Vec(vectorSize=3, minCount=0, inputCol="base_words", outputCol="features")
            model3 = word2Vec3.fit(train_data_raw3)
            final_data = model3.transform(train_data_raw3)
            final_data = final_data.select("type", "features", "timestamp")
            
            predictdata = lrModelg.transform(final_data)#.filter("prediction = 0")
            predictdata.createOrReplaceTempView("sentimental")
            finalDataFrame = spark.sql("select type, prediction, timestamp, count(*) as total from sentimental group by type, prediction, timestamp order by total desc limit 10")
            finalDataFrame.write.mode("append").saveAsTable("mlPredictions")
            print("Info saved to mlPrediction",time)

if __name__ == "__main__":
    sc = SparkContext(appName="Project BigData 3: Sentimental Analysis Consumer")
    lrModelg=machinelearnig() 
    streaming()